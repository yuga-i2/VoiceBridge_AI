# v1.3.2 Release Notes - Sarvam TTS Critical Fixes

## Summary
Applied three surgical fixes to the `/api/sarvam-tts` endpoint to resolve language code handling, speaker mapping, and API response parsing issues.

## Fixes Applied

### FIX 1: Language Code Normalization (app.py lines 267-271)
**Problem:** Language codes were being lowercased (`ml-IN` → `ml-in`), causing speaker_map lookups to fail.

**Solution:**
```python
language = (data.get('language') or '').strip()
# Normalize to BCP-47 format e.g. ml-IN (not ml-in)
if '-' in language:
    parts = language.split('-')
    language = parts[0].lower() + '-' + parts[1].upper()
```

**Impact:** Language codes now preserve BCP-47 format for consistent speaker_map matching.

---

### FIX 2: Speaker Map Keys (app.py lines 285-291)
**Problem:** Speaker map used abbreviated codes ('ml', 'ta') but incoming language parameters use full locale codes ('ml-IN', 'ta-IN').

**Before:**
```python
speaker_map = {
    'tamil': 'kavya', 'ta': 'kavya',
    'kannada': 'shreya', 'kn': 'shreya',
    'telugu': 'meera', 'te': 'meera',
    'malayalam': 'pavithra', 'ml': 'pavithra'
}
```

**After:**
```python
speaker_map = {
    'ta-IN': 'kavya',
    'kn-IN': 'arjun',
    'te-IN': 'meera',
    'ml-IN': 'pavithra',
    'hi-IN': 'meera'
}
```

**Impact:** 
- All speaker assignments now match on first try (no fallback needed)
- Default fallback changed to 'meera' (more universal than 'kavya')
- Direct BCP-47 format reduces lookup misses

---

### FIX 3: Sarvam Response Parsing (app.py lines 315-318)
**Problem:** Code checked for `'status'` field in Sarvam response, but Sarvam API doesn't return this field, causing valid responses to be rejected.

**Before:**
```python
if not result.get('status') == 'success' or not result.get('audios'):
    logger.error(f"Sarvam API unexpected response: {result}")
    return jsonify({'success': False, 'error': 'Invalid Sarvam response'}), 500
```

**After:**
```python
audios = result.get('audios') or []
if not audios:
    logger.error(f"Sarvam API no audio in response: {result}")
    return jsonify({'success': False, 'error': 'No audio from Sarvam'}), 500
```

**Impact:** Only validates actual Sarvam response structure (audios array).

---

## Diagnostic Logging Added

### Backend (app.py line 294)
```python
logger.info(f"Sarvam TTS: lang={language} speaker={speaker_id} text_len={len(text)}")
```
Logs language code, assigned speaker, and text length for debugging.

### Frontend (App.js line 763)
```javascript
console.log('[Lang] playWithLanguage: lang=' + selectedLanguage + ' isHindi=' + isHindi)
```
Tracks which audio path is selected (Hindi Polly vs. Regional Sarvam).

---

## Validation Results

### Local Tests (test_fixes.py)
✅ Language normalization: All 5 language codes correctly normalized to BCP-47
✅ Speaker map matching: All 5 languages correctly mapped to speakers
✅ Response parsing: Handles valid/invalid Sarvam responses correctly

### Build Status
- Backend: ✅ No syntax errors
- Frontend: ✅ Builds successfully (86.02 kB gzipped)

---

## Testing Checklist

- [ ] Test Malayalam (ml-IN) TTS via Sarvam API
- [ ] Test Tamil (ta-IN) TTS via Sarvam API
- [ ] Test Kannada (kn-IN) TTS via Sarvam API
- [ ] Test Telugu (te-IN) TTS via Sarvam API
- [ ] Verify correct speakers assigned in Lambda logs
- [ ] Verify diagnostic logs show language selection
- [ ] Verify no audio errors in browser console
- [ ] Verify live app plays regional voices correctly

---

## Files Modified
- `voicebridge-backend/app.py` (3 fixes, 1 diagnostic log)
- `frontend/src/App.js` (1 diagnostic log)

## Commit
- Hash: `766fbe2`
- Message: "v1.3.2 fix Sarvam TTS: language code normalization, speaker map keys, response parsing"

---

## Next Steps for Deployment

1. **Backend deployment:** `zappa update dev` in voicebridge-backend/
2. **Test endpoint:** Verify Sarvam API responds correctly with new fixes
3. **Frontend deployment:** Commit and push to master (auto-deploys via Amplify)
4. **End-to-end testing:** Test each language in live app

